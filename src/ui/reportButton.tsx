import * as React from "react";
import { getVideoID } from "../../maze-utils/src/video";
import Config from "../config/config";
import { createRoot, Root } from "react-dom/client";
import { SubmissionData } from "../utils/dataFetching";
import { ReportInterfaceComponent } from "./ReportInterfaceComponent";
import { logError } from "../utils/logger";
import { ButtonPlacementResult, PlacementPosition } from "../utils/siteInfo.types";
import { closeAllButtons } from "../utils/siteHandler";


//todo: sometimes make it solid colour based on the website theme
// const reportButtonIcon = `
// <?xml version="1.0" encoding="UTF-8"?>
// <svg aria-hidden="true" role="img" version="1.1" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
// <path d="m25.464 0.64116c-0.20143-0.0069253-0.40217-0.0045076-0.6017 0.0069434-0.41061 0.4553-0.70312 1.0669-0.76456 1.6759-0.011993 0.15135-0.016041 0.30324-0.012041 0.45501-0.00153 0.10734 0.007887 0.21457 0.028037 0.32001 0.14 0.662 0.50397 1.188 0.92197 1.71 0.09159 0.11691 0.18951 0.22873 0.29329 0.33495 0.24872 0.0031647 0.498 0.04872 0.7287 0.13403 0.060679 0.022409 0.11979 0.046824 0.17728 0.073125 0.37129-0.56568 0.85358-1.0502 1.4178-1.4241 0.813-0.543 1.7719-0.81907 2.7439-0.86607 0.035639-0.001782 0.10054-0.0019121 0.14326-0.0026367-0.96909-1.0533-2.2263-1.8454-3.6922-2.2193-0.45988-0.11738-0.92354-0.18202-1.3838-0.19784zm-2.9383 0.57437c-1.8622 0.82575-3.3267 2.4796-3.724 4.5945 0.13019 0.086349 0.27334 0.19638 0.40799 0.27501 0.64054 0.3789 1.3263 0.67552 2.041 0.88295 0.7548 0.21115 1.535 0.31781 2.3187 0.31702-0.060074-0.42264-0.027297-0.83976 0.15231-1.226 0.013389-0.028784 0.027534-0.056835 0.042364-0.084199-0.16514-0.19685-0.32462-0.39831-0.47742-0.59783-0.522-0.681-0.87694-1.4269-0.98394-2.2809-0.07202-0.6115 0.007882-1.3 0.22298-1.8805zm8.055 3.5264c-0.65949 0.0087-1.3046 0.19416-1.868 0.53701-0.45 0.271-0.86597 0.71604-1.147 1.235-0.016622 0.02992-0.027015 0.062616-0.039815 0.094043 0.40192 0.73037 0.58205 1.6178 0.63281 2.4029 0.174 2.697 4.404 2.723 4.531 0 0.069203-1.4723-0.26213-2.9186-0.91644-4.1853-0.040753-0.0070829-0.097685-0.018038-0.13658-0.02373-0.347-0.05-0.705-0.066029-1.056-0.060029zm-11.81 1.2499c-0.007817 0.049806-0.015076 0.099828-0.021709 0.15012-0.037044 0.28126-0.055464 0.55946-0.056953 0.83479 0.004188-0.27286 0.025202-0.54555 0.059941-0.81677 0.007547-0.054718 0.012952-0.11151 0.018721-0.16813zm-0.045352 1.696c0.1172 1.1914 0.53371 2.3273 1.1013 3.4153 1.0591 0.36011 2.1743 0.52667 3.2924 0.49175 0.71331-0.029226 1.4204-0.14474 2.1059-0.344 0.11833-0.034513 0.22893-0.077703 0.34225-0.11821-0.2607-0.38306-0.51758-0.76853-0.76816-1.1578-0.19843-0.30807-0.42679-0.66714-0.63396-1.0532-1.3674 0.077723-2.7656-0.12997-4.0311-0.59977-0.48644-0.18042-0.96187-0.39013-1.4086-0.63413zm10.558 0.47303a0.53076 0.53076 0 0 1 0.53077 0.53077 0.53076 0.53076 0 0 1-0.53077 0.53068 0.53076 0.53076 0 0 1-0.53077-0.53068 0.53076 0.53076 0 0 1 0.53077-0.53077zm2.2577 0.076553a0.53076 0.53076 0 0 1 0.53077 0.53077 0.53076 0.53076 0 0 1-0.53077 0.53077 0.53076 0.53076 0 0 1-0.53068-0.53077 0.53076 0.53076 0 0 1 0.53068-0.53077zm-23.563 3.5581c-0.29498 0.095428-0.58519 0.20641-0.86933 0.33363-0.0097918 0.06791-0.026793 0.16237-0.030234 0.22087-0.048 0.797 0.095977 1.571 0.36598 2.319 0.263 0.731 0.67502 1.396 1.151 2.009 0.015061 0.018826 0.032933 0.034781 0.049394 0.052207 0.11803-0.093765 0.24472-0.17943 0.38048-0.25602-0.63292-1.0461-1.2572-3.3301-1.0473-4.6787zm18.566 0.74531c-0.23278 0.085904-0.47503 0.16822-0.7048 0.23915-0.85949 0.25891-1.7488 0.4055-2.6459 0.43602-0.72609 0.026893-1.4641-0.041492-2.1913-0.17147 0.75024 1.1112 1.5707 2.172 2.2763 3.1915 0.038002 0.054901 0.076044 0.10983 0.11408 0.1648 0.39802 0.036941 0.79893 0.088096 1.1929 0.080156 0.679-0.014 1.3628-0.13203 2.0138-0.32203 0.66058-0.19329 1.2735-0.4948 1.8645-0.84516-0.1902-0.28329-0.38191-0.56512-0.57428-0.84577-0.44259-0.64558-0.89498-1.2856-1.3453-1.9272zm-9.296 0.46063c-0.34395 0.7947-0.944 1.8998-1.5736 2.8179 0.44542-0.40825 0.92689-0.77629 1.4528-1.0884 0.45314-0.26144 0.9984-0.49636 1.5018-0.65092-0.42204-0.40175-0.88185-0.7643-1.381-1.0786zm-12.041 0.3157c-1.1791 0.98774-1.9676 2.217-2.4444 3.5662 0.51929 0.95811 1.3883 1.7987 2.2229 2.4317 0.69174 0.51691 1.4465 0.94359 2.246 1.2698-0.010001-0.75424 0.078761-1.5216 0.31148-2.2055-0.87565-0.96943-1.5783-2.1285-1.9805-3.3143-0.18342-0.55913-0.31263-1.1608-0.35552-1.7478zm14.728 2.2865c-0.30919 0.063028-0.66848 0.14054-0.96108 0.25233-0.58362 0.23767-1.1305 0.55725-1.624 0.94904-0.56867 0.45889-1.1696 1.0146-1.6094 1.642 0.11693 0.16884 0.22532 0.345 0.3244 0.52796 0.339 0.62594 0.59179 1.2707 0.78539 1.9285 0.28235-0.2566 0.58082-0.49497 0.89358-0.7135 1.0918-0.74108 2.4834-1.2388 3.835-1.3159-0.40238-1.1606-0.9459-2.2774-1.6439-3.2704zm9.4441 1.1085-0.12243 0.07084c-0.68838 0.40198-1.4227 0.71957-2.1871 0.94597v8.8e-5c-0.78015 0.22406-1.5873 0.34007-2.399 0.34497-0.040511 0-0.093559-0.001665-0.13606-0.001934 0.68672 1.0283 1.3469 2.0784 1.9238 3.1676 0.12579 0.005084 0.25076 0.01326 0.37758 0.011338 0.76085-0.01657 1.5165-0.12948 2.2489-0.33601 0.75514-0.2083 1.4916-0.52318 2.1647-0.92399-0.55839-1.1264-1.1954-2.2152-1.8704-3.2788zm-27.152 2.6726c-0.13222 1.4239-0.0081888 2.894 0.29751 4.2949 0.26725 0.12039 0.54986 0.22298 0.83197 0.30243 0.69015 0.17575 1.3998 0.26308 2.112 0.25998 0.81386 9.98e-4 1.6148-0.10448 2.4117-0.23897-0.15704-0.4745-0.28912-0.9567-0.40271-1.4331-0.011067-0.046456-0.02188-0.093415-0.032344-0.14089-1.4364-0.32039-2.7908-0.99596-3.9537-1.9041-0.41409-0.32329-0.85623-0.71339-1.2645-1.1403zm19.822 1.1255c-1.1556 0.17649-2.3491 0.52293-3.3384 1.2008-0.53509 0.37329-1.0103 0.82576-1.4093 1.3419 0.17504 1.2146 0.27575 2.4503 0.41186 3.6787 0.33641-0.40552 0.70138-0.7888 1.1195-1.1016 0.7476-0.56423 1.5977-0.97788 2.503-1.218 0.40554-0.10688 0.81403-0.15384 1.2226-0.16392-0.090045-1.1208-0.19485-2.2392-0.42354-3.3471-0.026917-0.13027-0.055442-0.26054-0.085605-0.39076zm9.8896 0.99404c-0.72372 0.40821-1.5163 0.73897-2.315 0.96671-0.77788 0.21841-1.5966 0.31849-2.4084 0.34383 0.34982 0.81486 0.64238 1.6544 0.85641 2.5252 0.044112 0.17962 0.088168 0.36755 0.12973 0.56136 0.69648 0.29824 1.4246 0.51651 2.1703 0.65065 0.97604 0.18064 1.9306 0.1484 2.8747 0.048868-0.11177-1.3338-0.42755-2.6572-0.83874-3.8579-0.1433-0.41857-0.30024-0.83129-0.46898-1.2387zm-23.417 4.0664c0.005163 0.010447 0.010362 0.020857 0.015557 0.031289-1.0563 0.2737-2.1428 0.41375-3.234 0.41695-0.69477-1e-3 -1.4345-0.065919-2.1612-0.21182 0.45328 1.2467 1.0588 2.4494 1.8225 3.5062 0.024073-0.006042 0.048835-0.009902 0.072773-0.016348 0.763-0.212 1.491-0.51 2.189-0.884 0.76965-0.42031 1.4944-0.9182 2.1628-1.4858-0.33484-0.41129-0.62105-0.86959-0.86739-1.3565zm14.169 0.30472c-0.96928 0.17651-1.9122 0.53705-2.6313 1.0956-0.544 0.422-0.94201 0.85503-1.302 1.418-0.2273 0.3559-0.38551 0.73199-0.53411 1.1019 0.46037 1.3834 1.2307 2.5789 2.2752 3.5031 0.003618-0.092763-0.003952-0.18836 0.004922-0.27809 0.099-0.974 0.46193-1.8679 0.97093-2.6989 0.38411-0.62455 0.92455-1.3407 1.5656-1.916-0.13539-0.44843-0.21531-0.94076-0.2736-1.466-0.028014-0.25305-0.052795-0.50624-0.075674-0.75955zm-13.157 1.2043c0.094246 0.10807 0.19253 0.21201 0.29496 0.31201-0.10186-0.10041-0.20061-0.20394-0.29496-0.31201zm18.908 0.67289c0.015052 0.76174-0.10251 1.5084-0.47276 2.1254-0.009747 0.2581-0.008065 0.52264 0.035596 0.73301 0.084709 0.41303 0.21384 0.81572 0.38505 1.201l0.039991 0.080947c0.21992 0.43479 0.48327 0.84622 0.78601 1.228l0.082001 0.097031 0.12999 0.143c0.10731 0.11464 0.2187 0.22534 0.33398 0.33196 0.1149 0.10694 0.23369 0.20973 0.35604 0.30806l0.055811 0.04333c0.77761-0.47416 1.458-1.1288 1.9841-1.9893 0.69992-1.1436 1.0339-2.4405 1.1136-3.7752-1.0723 0.12302-2.2046 0.056452-3.2275-0.11188-0.54462-0.089937-1.0783-0.24053-1.6019-0.41537zm-10.604 0.091319c0.00384 0.026561 0.004749 0.05355 0.008877 0.080068 0.026523 0.17059 0.057097 0.33921 0.091757 0.50572-0.033143-0.16063-0.06245-0.32302-0.087802-0.48674-0.005067-0.032809-0.008013-0.06618-0.012832-0.099053zm-7.1532 0.24592c-0.76207 0.73712-1.6254 1.3618-2.5639 1.8552-0.61501 0.32148-1.2659 0.57714-1.9268 0.7969 1.401 1.3575 3.1763 2.2609 5.3468 2.3491 2.66 0.108 3.307-3.749 0.64398-4.377-0.56116-0.13235-1.0584-0.34616-1.5001-0.6242zm13.115 1.389c0.077475 0.082961 0.16074 0.16233 0.2504 0.2381-0.33491 0.37199-0.63018 0.77789-0.88102 1.211-0.35 0.609-0.65293 1.289-0.67693 2.002-0.01578 0.49608 0.087084 0.96106 0.20312 1.4266 0.38149 0.1562 0.78298 0.28699 1.2038 0.3905 1.4118 0.34742 2.9069 0.40982 4.2795 0.095449-0.45139-0.4446-0.86585-0.93913-1.1825-1.4835-0.387-0.666-0.69699-1.405-0.84199-2.164-0.030852-0.16122-0.060734-0.38106-0.082705-0.59608-0.39692-0.072105-0.79522-0.21404-1.1483-0.36299-0.4718-0.19911-0.83756-0.45425-1.1234-0.75709z"/>
// <path d="m8.543 10.815c1.604-0.757 6.861-0.757 9 1.292-0.089 0.98-2.871 6.032-3.876 5.347-0.98-0.668-2.495-0.802-4.144-0.446-0.936-0.356-2.435-5.506-0.98-6.193z"/>
// </svg>
// `;
const reportButtonIcon = `
<?xml version="1.0" encoding="UTF-8"?>
<svg aria-hidden="true" role="img" version="1.1" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
<path d="M32.407 22.743c-1.024-2.991-2.742-5.684-4.518-8.275c-1.027-1.498-2.107-2.966-3.09-4.493c-.666-1.034-1.669-2.643-1.077-3.916c.407-.875 1.495-1.092 2.336-.781c1.492.551 2.009 2.31 2.101 3.733c.174 2.697 4.404 2.723 4.531 0c.174-3.702-2.184-7.239-5.842-8.172c-3.679-.939-7.597 1.497-8.099 5.303c-.508 3.857 2.49 7.148 4.529 10.094c1.952 2.82 3.963 5.727 4.793 9.104c.347 1.413.691 3.337-.163 4.634c-.68 1.034-2.007.675-2.986.262c-1.59-.671-1.976-1.979-2.156-3.601c-.212-1.915-.241-3.84-.632-5.734c-.73-3.533-2.647-7.084-6.106-8.534c-3.431-1.44-7.713-1.578-10.728.873c-3.472 2.822-3.656 7.694-2.457 11.668c1.238 4.101 4.069 7.995 8.697 8.183c2.66.108 3.307-3.749.644-4.377c-2.879-.679-4.077-3.502-4.707-6.144c-.541-2.271-.381-5.801 2.429-6.429c2.481-.555 4.979.657 6.158 2.834c1.504 2.777 1.311 5.923 1.782 8.949c.526 3.383 2.661 5.989 6.052 6.823c3.06.753 6.511.167 8.259-2.692c1.685-2.753 1.249-6.395.25-9.312z"/>
<path d="M25.839 12.78c.23-.071.464-.149.697-.235c-.328-.467-.643-.943-.964-1.414c-.115.041-.227.085-.347.12a8.842 8.842 0 0 1-2.106.344a9.323 9.323 0 0 1-3.296-.493c.345.664.746 1.311 1.17 1.941c.73.131 1.471.2 2.2.173a10.4 10.4 0 0 0 2.646-.436zm1.215 4.956a9.929 9.929 0 0 0 2.187-.946l.128-.074a62.191 62.191 0 0 0-.914-1.399c-.593.352-1.208.655-1.871.849c-.651.19-1.32.301-1.999.315c-.397.008-.801-.044-1.202-.081c.382.552.764 1.109 1.14 1.672c.044 0 .088.009.132.009a8.883 8.883 0 0 0 2.399-.345zm4.876 3.769a24.73 24.73 0 0 0-.692-1.509a8.757 8.757 0 0 1-2.154.919a9.01 9.01 0 0 1-2.249.336c-.132.002-.262-.007-.393-.012c.274.517.535 1.04.766 1.576c.814-.025 1.635-.125 2.415-.344a10.552 10.552 0 0 0 2.307-.966zm1.33 6.772c.032-.556.024-1.116-.024-1.676c-.946.1-1.887.132-2.865-.049a10.02 10.02 0 0 1-2.171-.651c.126.584.228 1.223.242 1.852c.524.175 1.056.325 1.601.415c1.027.169 2.141.234 3.217.109zm-13.201-1.306c.721-.56 1.667-.921 2.639-1.097c-.049-.542-.095-1.084-.139-1.626c-.409.01-.818.057-1.224.164a7.233 7.233 0 0 0-2.503 1.218c-.425.318-.796.708-1.137 1.121c.044.399.094.797.155 1.192c.083.536.221 1.044.384 1.538c.149-.371.295-.735.523-1.092c.36-.563.758-.996 1.302-1.418zm-1.349-5.26c1.01-.692 2.147-1.031 3.325-1.204a15.956 15.956 0 0 0-.472-1.623c-1.36.072-2.721.56-3.82 1.306a8.953 8.953 0 0 0-.903.722c.208.703.351 1.42.456 2.147a6.435 6.435 0 0 1 1.414-1.348zm-1.361-4.906a6.64 6.64 0 0 1 1.624-.949c.301-.115.616-.191.931-.255a10.07 10.07 0 0 0-1.303-1.506a6.938 6.938 0 0 0-1.474.636c-1.05.623-1.923 1.469-2.685 2.413c.493.365.925.81 1.283 1.324c.441-.636 1.049-1.199 1.624-1.663zm-9.905-2.136c-.27-.748-.414-1.522-.366-2.319c.004-.068.021-.132.029-.199a8.095 8.095 0 0 0-1.802 1.107c-.03.024-.055.051-.084.076a7.22 7.22 0 0 0 .341 1.731c.404 1.191 1.111 2.355 1.992 3.327c.224-.653.579-1.228 1.106-1.644c-.02-.025-.045-.045-.065-.07c-.476-.613-.888-1.278-1.151-2.009zm-4.67 2.233c-.281.796-.46 1.631-.54 2.485c.409.428.842.814 1.257 1.138c1.164.909 2.52 1.585 3.958 1.905a9.177 9.177 0 0 1-.21-1.842a10.169 10.169 0 0 1-2.254-1.273c-.836-.634-1.692-1.453-2.211-2.413zm.582 7.08a5.909 5.909 0 0 1-.827-.301c.092.422.196.84.318 1.246c.089.295.189.588.294.88c.727.146 1.467.211 2.162.212a13.046 13.046 0 0 0 3.234-.417a11.429 11.429 0 0 1-.651-1.6c-.799.135-1.602.241-2.418.24a8.409 8.409 0 0 1-2.112-.26zm1.681 5.315c-.026.007-.053.011-.079.018c.372.516.785.993 1.232 1.428c.662-.22 1.314-.476 1.93-.798a11.15 11.15 0 0 0 2.572-1.863a5.36 5.36 0 0 1-1.297-1.16a12.877 12.877 0 0 1-2.169 1.491c-.698.374-1.426.672-2.189.884zM24.163 8.922c-.277-.519-.507-1.081-.582-1.637a8.575 8.575 0 0 1-2.33-.317a8.858 8.858 0 0 1-2.041-.883c-.137-.08-.261-.177-.393-.264c-.021.113-.049.223-.065.339a6.73 6.73 0 0 0-.021 1.526c.448.245.915.455 1.403.636c1.266.47 2.661.678 4.029.6zm-1.86-5.826c.107.854.462 1.6.984 2.281c.157.205.321.412.491.614c.316-.576.941-.839 1.572-.826a4.076 4.076 0 0 1-.314-.356c-.418-.522-.782-1.048-.922-1.71a1.585 1.585 0 0 1-.028-.32a4.32 4.32 0 0 1 .012-.455A2.875 2.875 0 0 1 24.84.669a6.703 6.703 0 0 0-2.3.568a3.878 3.878 0 0 0-.237 1.859zm5.35.831a5 5 0 0 0-1.434 1.449c.579.262 1.001.711 1.299 1.251c.017-.037.028-.077.048-.113c.281-.519.697-.964 1.147-1.235a3.687 3.687 0 0 1 1.868-.537c.351-.006.709.01 1.056.06c.041.006.081.015.122.022a8.062 8.062 0 0 0-1.238-1.762c-.041.001-.084-.003-.124-.001c-.972.047-1.931.323-2.744.866zm2.108 29.766a6.536 6.536 0 0 1-.334-.332l-.13-.143l-.082-.097a7.225 7.225 0 0 1-.786-1.228l-.04-.081a5.854 5.854 0 0 1-.385-1.201c-.044-.212-.042-.475-.032-.735c-.022.038-.036.079-.06.116c-.436.662-1.137.75-1.842.621c.022.216.052.42.083.582c.145.759.455 1.498.842 2.164c.317.545.732 1.04 1.184 1.485a6.647 6.647 0 0 0 1.989-.804l-.051-.039a6.49 6.49 0 0 1-.356-.308zm-6.593-2.765a7.21 7.21 0 0 1 .881-1.211c-.51-.431-.815-.981-1.005-1.62c-.643.576-1.185 1.294-1.57 1.92c-.509.831-.872 1.725-.971 2.699c-.009.091-.001.188-.005.282a7.697 7.697 0 0 0 2.201 1.378c-.118-.472-.224-.943-.208-1.446c.024-.713.327-1.393.677-2.002z" opacity=".85"/>
<path d="M8.543 10.815c1.604-.757 6.861-.757 9 1.292c-.089.98-2.871 6.032-3.876 5.347c-.98-.668-2.495-.802-4.144-.446c-.936-.356-2.435-5.506-.98-6.193z"/>
<path d="M11.885 14.58c1.76.156 3.096.802 3.787 1.158c.06-.055.119-.116.173-.178c.48-.731.927-1.539 1.243-2.211l.032-.084c-.98-.891-3.257-1.565-5.69-1.562c-2.241.003-3.493.795-3.493.795s-.127.829.475 2.558c.001.001 1.465-.654 3.473-.476z"/>
<g transform="matrix(3.1631 0 0 3.1631 -63.672 -21.345)" stroke-width=".12303">
<circle cx="29.387" cy="9.4958" r=".1678"/>
<circle cx="30.101" cy="9.52" r=".1678"/>
</g>
</svg>`;
// const reportButtonIcon = `
// <?xml version="1.0" encoding="UTF-8"?>
// <svg aria-hidden="true" role="img" version="1.1" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
// <path d="M32.407 22.743c-1.024-2.991-2.742-5.684-4.518-8.275c-1.027-1.498-2.107-2.966-3.09-4.493c-.666-1.034-1.669-2.643-1.077-3.916c.407-.875 1.495-1.092 2.336-.781c1.492.551 2.009 2.31 2.101 3.733c.174 2.697 4.404 2.723 4.531 0c.174-3.702-2.184-7.239-5.842-8.172c-3.679-.939-7.597 1.497-8.099 5.303c-.508 3.857 2.49 7.148 4.529 10.094c1.952 2.82 3.963 5.727 4.793 9.104c.347 1.413.691 3.337-.163 4.634c-.68 1.034-2.007.675-2.986.262c-1.59-.671-1.976-1.979-2.156-3.601c-.212-1.915-.241-3.84-.632-5.734c-.73-3.533-2.647-7.084-6.106-8.534c-3.431-1.44-7.713-1.578-10.728.873c-3.472 2.822-3.656 7.694-2.457 11.668c1.238 4.101 4.069 7.995 8.697 8.183c2.66.108 3.307-3.749.644-4.377c-2.879-.679-4.077-3.502-4.707-6.144c-.541-2.271-.381-5.801 2.429-6.429c2.481-.555 4.979.657 6.158 2.834c1.504 2.777 1.311 5.923 1.782 8.949c.526 3.383 2.661 5.989 6.052 6.823c3.06.753 6.511.167 8.259-2.692c1.685-2.753 1.249-6.395.25-9.312z" fill="#ff8151"/>
// <path d="M25.839 12.78c.23-.071.464-.149.697-.235c-.328-.467-.643-.943-.964-1.414c-.115.041-.227.085-.347.12a8.842 8.842 0 0 1-2.106.344a9.323 9.323 0 0 1-3.296-.493c.345.664.746 1.311 1.17 1.941c.73.131 1.471.2 2.2.173a10.4 10.4 0 0 0 2.646-.436zm1.215 4.956a9.929 9.929 0 0 0 2.187-.946l.128-.074a62.191 62.191 0 0 0-.914-1.399c-.593.352-1.208.655-1.871.849c-.651.19-1.32.301-1.999.315c-.397.008-.801-.044-1.202-.081c.382.552.764 1.109 1.14 1.672c.044 0 .088.009.132.009a8.883 8.883 0 0 0 2.399-.345zm4.876 3.769a24.73 24.73 0 0 0-.692-1.509a8.757 8.757 0 0 1-2.154.919a9.01 9.01 0 0 1-2.249.336c-.132.002-.262-.007-.393-.012c.274.517.535 1.04.766 1.576c.814-.025 1.635-.125 2.415-.344a10.552 10.552 0 0 0 2.307-.966zm1.33 6.772c.032-.556.024-1.116-.024-1.676c-.946.1-1.887.132-2.865-.049a10.02 10.02 0 0 1-2.171-.651c.126.584.228 1.223.242 1.852c.524.175 1.056.325 1.601.415c1.027.169 2.141.234 3.217.109zm-13.201-1.306c.721-.56 1.667-.921 2.639-1.097c-.049-.542-.095-1.084-.139-1.626c-.409.01-.818.057-1.224.164a7.233 7.233 0 0 0-2.503 1.218c-.425.318-.796.708-1.137 1.121c.044.399.094.797.155 1.192c.083.536.221 1.044.384 1.538c.149-.371.295-.735.523-1.092c.36-.563.758-.996 1.302-1.418zm-1.349-5.26c1.01-.692 2.147-1.031 3.325-1.204a15.956 15.956 0 0 0-.472-1.623c-1.36.072-2.721.56-3.82 1.306a8.953 8.953 0 0 0-.903.722c.208.703.351 1.42.456 2.147a6.435 6.435 0 0 1 1.414-1.348zm-1.361-4.906a6.64 6.64 0 0 1 1.624-.949c.301-.115.616-.191.931-.255a10.07 10.07 0 0 0-1.303-1.506a6.938 6.938 0 0 0-1.474.636c-1.05.623-1.923 1.469-2.685 2.413c.493.365.925.81 1.283 1.324c.441-.636 1.049-1.199 1.624-1.663zm-9.905-2.136c-.27-.748-.414-1.522-.366-2.319c.004-.068.021-.132.029-.199a8.095 8.095 0 0 0-1.802 1.107c-.03.024-.055.051-.084.076a7.22 7.22 0 0 0 .341 1.731c.404 1.191 1.111 2.355 1.992 3.327c.224-.653.579-1.228 1.106-1.644c-.02-.025-.045-.045-.065-.07c-.476-.613-.888-1.278-1.151-2.009zm-4.67 2.233c-.281.796-.46 1.631-.54 2.485c.409.428.842.814 1.257 1.138c1.164.909 2.52 1.585 3.958 1.905a9.177 9.177 0 0 1-.21-1.842a10.169 10.169 0 0 1-2.254-1.273c-.836-.634-1.692-1.453-2.211-2.413zm.582 7.08a5.909 5.909 0 0 1-.827-.301c.092.422.196.84.318 1.246c.089.295.189.588.294.88c.727.146 1.467.211 2.162.212a13.046 13.046 0 0 0 3.234-.417a11.429 11.429 0 0 1-.651-1.6c-.799.135-1.602.241-2.418.24a8.409 8.409 0 0 1-2.112-.26zm1.681 5.315c-.026.007-.053.011-.079.018c.372.516.785.993 1.232 1.428c.662-.22 1.314-.476 1.93-.798a11.15 11.15 0 0 0 2.572-1.863a5.36 5.36 0 0 1-1.297-1.16a12.877 12.877 0 0 1-2.169 1.491c-.698.374-1.426.672-2.189.884zM24.163 8.922c-.277-.519-.507-1.081-.582-1.637a8.575 8.575 0 0 1-2.33-.317a8.858 8.858 0 0 1-2.041-.883c-.137-.08-.261-.177-.393-.264c-.021.113-.049.223-.065.339a6.73 6.73 0 0 0-.021 1.526c.448.245.915.455 1.403.636c1.266.47 2.661.678 4.029.6zm-1.86-5.826c.107.854.462 1.6.984 2.281c.157.205.321.412.491.614c.316-.576.941-.839 1.572-.826a4.076 4.076 0 0 1-.314-.356c-.418-.522-.782-1.048-.922-1.71a1.585 1.585 0 0 1-.028-.32a4.32 4.32 0 0 1 .012-.455A2.875 2.875 0 0 1 24.84.669a6.703 6.703 0 0 0-2.3.568a3.878 3.878 0 0 0-.237 1.859zm5.35.831a5 5 0 0 0-1.434 1.449c.579.262 1.001.711 1.299 1.251c.017-.037.028-.077.048-.113c.281-.519.697-.964 1.147-1.235a3.687 3.687 0 0 1 1.868-.537c.351-.006.709.01 1.056.06c.041.006.081.015.122.022a8.062 8.062 0 0 0-1.238-1.762c-.041.001-.084-.003-.124-.001c-.972.047-1.931.323-2.744.866zm2.108 29.766a6.536 6.536 0 0 1-.334-.332l-.13-.143l-.082-.097a7.225 7.225 0 0 1-.786-1.228l-.04-.081a5.854 5.854 0 0 1-.385-1.201c-.044-.212-.042-.475-.032-.735c-.022.038-.036.079-.06.116c-.436.662-1.137.75-1.842.621c.022.216.052.42.083.582c.145.759.455 1.498.842 2.164c.317.545.732 1.04 1.184 1.485a6.647 6.647 0 0 0 1.989-.804l-.051-.039a6.49 6.49 0 0 1-.356-.308zm-6.593-2.765a7.21 7.21 0 0 1 .881-1.211c-.51-.431-.815-.981-1.005-1.62c-.643.576-1.185 1.294-1.57 1.92c-.509.831-.872 1.725-.971 2.699c-.009.091-.001.188-.005.282a7.697 7.697 0 0 0 2.201 1.378c-.118-.472-.224-.943-.208-1.446c.024-.713.327-1.393.677-2.002z" fill="#bf5c34" opacity=".85"/>
// <path d="M8.543 10.815c1.604-.757 6.861-.757 9 1.292c-.089.98-2.871 6.032-3.876 5.347c-.98-.668-2.495-.802-4.144-.446c-.936-.356-2.435-5.506-.98-6.193z" fill="#bf5b34"/>
// <path d="M11.885 14.58c1.76.156 3.096.802 3.787 1.158c.06-.055.119-.116.173-.178c.48-.731.927-1.539 1.243-2.211l.032-.084c-.98-.891-3.257-1.565-5.69-1.562c-2.241.003-3.493.795-3.493.795s-.127.829.475 2.558c.001.001 1.465-.654 3.473-.476z" fill="#d67650"/>
// <g transform="matrix(3.1631 0 0 3.1631 -63.672 -21.345)" fill="#bf5b34" stroke-width=".12303">
// <circle cx="29.387" cy="9.4958" r=".1678"/>
// <circle cx="30.101" cy="9.52" r=".1678"/>
// </g>
// </svg>`;

export class ReportButton {
    button: HTMLButtonElement;
    container: HTMLElement | null;
    root: Root | null;
    postElement: HTMLElement;
    referenceNode: HTMLElement;
    buttonPlacement: ButtonPlacementResult;

    mutationObserver: MutationObserver | null = null;

    buttonIcon: string;
    buttonTitle: string;
    className: string;

    existingVotes: SubmissionData[];

    constructor(postElement: HTMLElement, buttonPlacement: ButtonPlacementResult) {
        this.postElement = postElement;
        this.referenceNode = buttonPlacement.element;
        this.buttonPlacement = buttonPlacement;
        this.buttonIcon = reportButtonIcon;
        this.buttonTitle = chrome.i18n.getMessage("OpenSlopReportMenu");
        this.className = "slVoteButton";

        this.container = null;
        this.root = null;

        this.existingVotes = [];
    }

    attachToPage(): void {
        if (!this.referenceNode.contains(this.button)) {
            if (!this.button) {
                const existingButton = this.referenceNode.querySelector(`.${this.className}`);
                if (existingButton) {
                    existingButton.remove();
                }

                this.button = document.createElement('button');
                this.button.className = `${this.className} cbButton cbTitleButton`;
                this.button.innerHTML = this.buttonIcon;
                this.button.title = this.buttonTitle;
                this.updateIcon();
                this.button.draggable = false;

                this.button.addEventListener("click", (e) => {
                    if (!chrome.runtime?.id) return;
                    e.stopPropagation();
                    e.preventDefault();

                    if (Config.config!.extensionEnabled) {
                        this.openOrClose().catch(logError);
                        closeAllButtons(this);
                    }
                });
            }

            const relativeElement = this.buttonPlacement.relativeElementSelector
                ? this.referenceNode.querySelector(this.buttonPlacement.relativeElementSelector)
                : null;
            switch (this.buttonPlacement.position) {
                case PlacementPosition.Before:
                    if (relativeElement) {
                        relativeElement.before(this.button);
                    } else {
                        this.referenceNode.prepend(this.button);
                    }
                    break;
                case PlacementPosition.After:
                    if (relativeElement) {
                        relativeElement.after(this.button);
                    } else {
                        this.referenceNode.appendChild(this.button);
                    }
                    break;
            }

            if (this.mutationObserver) {
                this.mutationObserver.disconnect();
            }
            this.mutationObserver = new MutationObserver(() => {
                if (!this.referenceNode.contains(this.button)) {
                    this.attachToPage();
                }
            });
            this.mutationObserver.observe(this.referenceNode, {
                childList: true
            });

            if (this.buttonPlacement.getColor) {
                const color = this.buttonPlacement.getColor(this.postElement, this.button);
                if (color) {
                    this.button.style.fill = color;
                }
            } else if (this.button.parentElement) {
                const style = window.getComputedStyle(this.button.parentElement!);
                if (style.color) {
                    this.button.style.fill = style.color;
                }
            }

            if (this.buttonPlacement.postProcessor) {
                this.buttonPlacement.postProcessor(this.postElement, this.button);
            }
        }
    }

    async openOrClose(): Promise<void> {
        const referenceNode = this.buttonPlacement.manuallyAlignSubmissionBox ? document.body : this.button?.parentElement;
        if (!referenceNode) return;

        if (referenceNode && !referenceNode.contains(this.container)) {
            if (!this.container) {
                this.container = document.createElement('span');
                this.container.classList.add("slSubmitMenu");

                this.root = createRoot(this.container);
                this.render();

                if (this.buttonPlacement.manuallyAlignSubmissionBox) {
                    const relElement = this.buttonPlacement.alignSubmissionBoxWithElement
                        ? this.postElement
                        : this.button;
                    const bounds = relElement.getBoundingClientRect();
                    this.container.style.left = `${bounds.x + window.scrollX}px`;
                    this.container.style.top = `${bounds.y + window.scrollY}px`;
                    this.container.style.right = "unset";
                }
            }

            referenceNode.insertBefore(this.container, referenceNode.firstChild);
        } else {
            this.close();
        }
    }

    close(): void {
        if (this.container) {
            this.root?.unmount?.();
            this.root = null;
            this.container.remove();
            this.container = null;
            this.mutationObserver?.disconnect();
            this.mutationObserver = null;

            this.updateIcon();
        }
    }

    clearExistingVotes(): void {
        this.existingVotes = [];
    }

    setExistingVotes(existingVotes: SubmissionData[]): void {
        this.existingVotes = existingVotes;
        this.render();
    }

    render(): void {
        if (this.root) {
            this.root?.render(<ReportInterfaceComponent
                videoID={getVideoID()!}
                existingVotes={this.existingVotes}
                submitClicked={(slop, subjective) => this.submitPressed(slop, subjective)}
            />);
        }
    }

    private async submitPressed(slopVoteTypes: string[], subjectiveVoteTypes: string[]): Promise<boolean> {
        console.log(slopVoteTypes, subjectiveVoteTypes)
        return await Promise.resolve(false);
        //todo: handle submission
        // if (getVideoID() !== getYouTubeVideoID()) {
        //     alert(chrome.i18n.getMessage("videoIDWrongWhenSubmittingError"));
        //     return false;
        // }

        // let result: FetchResponse;
        // try {
        //     result = await submitVideoCasualVote(getVideoID()!, categories, downvote);
        // } catch (e) {
        //     logError("Caught error while submitting casual title vote", e);
        //     alert(formatJSErrorMessage(e));
        //     return false;
        // }

        // if (result && result.ok) {
        //     this.close();

        //     if (shouldStoreVotes()) {
        //         const unsubmitted = Config.local!.unsubmitted[getVideoID()!] ??= {
        //             thumbnails: [],
        //             titles: []
        //         };

        //         unsubmitted.casual = !downvote;
        //         Config.forceLocalUpdate("unsubmitted");
        //     }

        //     setTimeout(() => replaceCurrentVideoBranding().catch(logError), 1100);

        //     return true;
        // } else {
        //     logRequest(result, "CB", "casual title vote");
        //     alert(getLongErrorMessage(result.status, result.responseText));
        //     return false;
        // }
    }

    updateIcon(): void {
        if (this.button) {
            if (Config.config!.extensionEnabled) {
                this.button.style.removeProperty("display");
            } else {
                this.button.style.display = "none";
            }
        }
    }
}